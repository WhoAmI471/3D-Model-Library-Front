# Backlog улучшений проекта

## Высокий приоритет

### 1. Создать кастомные хуки для повторяющейся логики

**Статус:** ✅ Завершено

**Описание:**
Многие компоненты дублируют логику загрузки данных (модели, сферы, пользователь), валидации форм, обработки состояния. Необходимо выделить переиспользуемые хуки.

**Задачи:**
- [x] Создать хук `useModelsData` для загрузки моделей, сфер и текущего пользователя
- [x] Создать хук `useModal` для управления состоянием модальных окон
- [x] Создать хук `usePagination` для пагинации
- [ ] Создать хук `useFormState` для управления состоянием форм (отложено - будет заменено на react-hook-form)
- [x] Создать хук `useDragAndDrop` для drag-and-drop функциональности
- [x] Рефакторинг `ProjectForm.jsx` для использования новых хуков
- [x] Рефакторинг `AddModelsToProjectModal.jsx` для использования новых хуков
- [x] Рефакторинг `DeleteReasonModal.jsx` для использования новых хуков
- [x] Рефакторинг `EmployeeForm.jsx` для использования новых хуков
- [x] Рефакторинг `ModelUploadForm.jsx` для использования новых хуков
- [x] Рефакторинг `ModelEditForm.jsx` для использования новых хуков

**Затронутые файлы:**
- `src/components/ModelUploadForm.jsx`
- `src/components/ModelEditForm.jsx`
- `src/components/ProjectForm.jsx`
- `src/components/AddModelsToProjectModal.jsx`

**Ожидаемый результат:**
- Уменьшение дублирования кода на 40-50%
- Улучшение читаемости компонентов
- Упрощение тестирования

---

### 2. Разбить большие компоненты на меньшие

**Статус:** ✅ Завершено

**Описание:**
Компоненты `ModelEditForm.jsx` и `ModelUploadForm.jsx` содержат более 1200 строк кода. Необходимо разбить их на более мелкие, переиспользуемые компоненты.

**Задачи:**

#### ModelEditForm.jsx
- [x] Выделить `ScreenshotsSection` компонент
- [x] Выделить `ModelInfoSection` компонент (название, описание, автор, версия, сфера)
- [x] Выделить `ProjectsSection` компонент
- [x] Выделить `FileUploadSection` компонент
- [x] Создать `FormActions` компонент (кнопки сохранения/отмены)

#### ModelUploadForm.jsx
- [x] Выделить `ScreenshotsUploadSection` компонент
- [x] Выделить `ModelInfoSection` компонент (переиспользовать из ModelEditForm)
- [x] Выделить `ProjectsSelectionSection` компонент
- [x] Выделить `FileUploadSection` компонент (переиспользовать из ModelEditForm)
- [x] Создать `FormActions` компонент (переиспользовать)

**Затронутые файлы:**
- `src/components/ModelEditForm.jsx` (1183 строк → 855 строк, сокращение на ~28%)
- `src/components/ModelUploadForm.jsx` (~700 строк → 421 строка, сокращение на ~40%)
- `src/components/modelForm/FormActions.jsx` (новый компонент)
- `src/components/modelForm/ModelInfoSection.jsx` (новый компонент)
- `src/components/modelForm/ScreenshotsSection.jsx` (новый компонент)
- `src/components/modelForm/ScreenshotsUploadSection.jsx` (новый компонент)
- `src/components/modelForm/ProjectsSection.jsx` (новый компонент)
- `src/components/modelForm/FileUploadSection.jsx` (новый компонент)

**Ожидаемый результат:**
- Уменьшение размера компонентов до 200-400 строк
- Улучшение читаемости и поддержки
- Возможность переиспользования компонентов

---

### 3. Ввести единый API клиент

**Статус:** ✅ Завершено

**Описание:**
В проекте смешиваются `fetch` и `axios` для API вызовов. Необходимо создать единый API клиент с централизованной обработкой ошибок, авторизацией и типизацией.

**Задачи:**
- [x] Создать `src/lib/apiClient.js` с базовым классом/функциями
- [x] Реализовать автоматическую обработку ошибок
- [x] Реализовать автоматическое добавление токенов авторизации (через httpOnly cookies)
- [x] Реализовать перехватчики (interceptors) для запросов/ответов
- [x] Создать специализированные методы для каждого ресурса:
  - [x] `apiClient.models.get()`, `apiClient.models.create()`, и т.д.
  - [x] `apiClient.projects.get()`, `apiClient.projects.create()`, и т.д.
  - [x] `apiClient.employees.get()`, `apiClient.employees.create()`, и т.д.
  - [x] `apiClient.spheres.get()`, `apiClient.spheres.create()`, и т.д.
  - [x] `apiClient.auth.login()`, `apiClient.auth.me()`, и т.д.
  - [x] `apiClient.logs.getAll()`, `apiClient.users.getAll()`
- [x] Рефакторинг всех компонентов для использования нового API клиента
- [x] Удалить неиспользуемые импорты `axios` (оставлены только в серверных файлах для Nextcloud)

**Затронутые файлы:**
- `src/lib/apiClient.js` (новый файл)
- `src/components/MainHeader.jsx` (заменить `axios` на `apiClient`)
- `src/components/ModelUploadForm.jsx`
- `src/components/ModelEditForm.jsx`
- `src/components/ProjectForm.jsx`
- `src/components/EmployeeForm.jsx`
- `src/components/AddModelsToProjectModal.jsx`
- Все страницы в `src/app/dashboard/`

**Ожидаемый результат:**
- Единообразный подход к API вызовам
- Централизованная обработка ошибок
- Упрощение добавления новых API endpoints
- Улучшение обработки авторизации

---

## Средний приоритет

### 4. Добавить валидацию через схему (Zod/Yup)

**Статус:** ✅ Завершено

**Описание:**
Валидация форм разбросана по компонентам и дублируется. Необходимо использовать схему валидации для единообразия и переиспользования.

**Выбранная библиотека:** Zod (современная, TypeScript-friendly, легковесная)

**Задачи:**
- [x] Установить `zod`: `npm install zod`
- [x] Создать схемы валидации:
  - [x] `src/lib/validations/modelSchema.js` - валидация моделей
  - [x] `src/lib/validations/projectSchema.js` - валидация проектов
  - [x] `src/lib/validations/employeeSchema.js` - валидация сотрудников
  - [x] `src/lib/validations/sphereSchema.js` - валидация сфер
- [x] Интегрировать схемы в формы (совместно с задачей #5) - завершено для всех форм
- [ ] Обновить серверную валидацию для использования тех же схем (опционально)

**Затронутые файлы:**
- `src/lib/validations/` (новая папка со схемами: modelSchema.js, projectSchema.js, employeeSchema.js, sphereSchema.js)
- `src/components/ModelUploadForm.jsx` ✅ (текстовые поля через react-hook-form + Zod, файлы валидируются вручную)
- `src/components/ModelEditForm.jsx` ✅ (текстовые поля через react-hook-form + Zod, файлы валидируются вручную)
- `src/components/ProjectForm.jsx` ✅ (полностью интегрирован с react-hook-form + Zod)
- `src/components/EmployeeForm.jsx` ✅ (полностью интегрирован с react-hook-form + Zod, условная валидация пароля)

**Ожидаемый результат:**
- ✅ Единообразная валидация на клиенте (схемы Zod созданы для всех форм)
- ✅ Уменьшение дублирования кода валидации (валидация централизована в схемах)
- ✅ Лучшие сообщения об ошибках (Zod автоматически генерирует понятные сообщения)

---

### 5. Использовать react-hook-form для форм

**Статус:** ✅ Завершено

**Описание:**
Управление состоянием форм через множество `useState` усложняет код. `react-hook-form` упростит управление формами и интеграцию с валидацией.

**Задачи:**
- [x] Установить `react-hook-form`: `npm install react-hook-form`
- [x] Установить `@hookform/resolvers` для интеграции с Zod: `npm install @hookform/resolvers`
- [x] Рефакторинг `EmployeeForm.jsx`:
  - [x] Заменить `useState` для формы на `useForm`
  - [x] Интегрировать с Zod схемой
  - [x] Обновить обработчики изменений
- [x] Рефакторинг `ProjectForm.jsx`:
  - [x] Заменить `useState` для формы на `useForm`
  - [x] Интегрировать с Zod схемой
- [x] Рефакторинг `ModelUploadForm.jsx`:
  - [x] Заменить `useState` для формы на `useForm` (частично - текстовые поля)
  - [x] Интегрировать с Zod схемой (текстовые поля)
  - [x] Обработать загрузку файлов (валидация файлов вручную перед отправкой)
- [x] Рефакторинг `ModelEditForm.jsx`:
  - [x] Заменить `useState` для формы на `useForm` (частично - текстовые поля)
  - [x] Интегрировать с Zod схемой (текстовые поля)
  - [x] Обработать загрузку файлов (валидация файлов вручную, сохранена существующая логика)

**Затронутые файлы:**
- `src/components/EmployeeForm.jsx`
- `src/components/ProjectForm.jsx`
- `src/components/ModelUploadForm.jsx`
- `src/components/ModelEditForm.jsx`

**Зависимости:**
- Требует завершения задачи #4 (валидация через Zod)

**Ожидаемый результат:**
- ✅ Упрощение управления состоянием форм (useForm вместо множества useState)
- ✅ Лучшая производительность (меньше ререндеров благодаря react-hook-form)
- ✅ Упрощение валидации (Zod схемы вместо ручной валидации)
- ✅ Меньше boilerplate кода (автоматическая обработка ошибок и валидации)

---

### 6. Централизовать обработку ошибок

**Статус:** ⏳ Не начато

**Описание:**
Обработка ошибок разбросана по компонентам и API routes. Необходимо создать централизованную систему обработки ошибок.

**Задачи:**
- [ ] Создать `src/lib/errorHandler.js` с функциями обработки ошибок
- [ ] Создать компонент `ErrorBoundary` для отлова ошибок React
- [ ] Создать утилиты для форматирования ошибок:
  - [ ] `formatApiError(error)` - форматирование ошибок API
  - [ ] `formatValidationError(error)` - форматирование ошибок валидации
  - [ ] `formatNetworkError(error)` - форматирование сетевых ошибок
- [ ] Создать `src/lib/errorMessages.js` с централизованными сообщениями об ошибках
- [ ] Интегрировать в API клиент (задача #3)
- [ ] Добавить глобальный ErrorBoundary в layout
- [ ] Обновить компоненты для использования централизованной обработки ошибок
- [ ] Добавить логирование ошибок на сервер (опционально)

**Затронутые файлы:**
- `src/lib/errorHandler.js` (новый файл)
- `src/lib/errorMessages.js` (новый файл)
- `src/components/ErrorBoundary.jsx` (новый компонент)
- `src/app/layout.js` (добавить ErrorBoundary)
- `src/lib/apiClient.js` (интеграция обработки ошибок)
- Все компоненты с обработкой ошибок

**Ожидаемый результат:**
- Единообразная обработка ошибок по всему приложению
- Улучшенный UX при ошибках
- Централизованное логирование ошибок
- Упрощение отладки

---

## Прогресс

### Общий прогресс: 5/6 задач завершено (83%)

**Высокий приоритет:** 3/3 (100%)
- [x] Кастомные хуки ✅ (полностью завершено - все хуки созданы и интегрированы во все компоненты)
- [x] Разбиение компонентов ✅ (завершено - создано 6 новых компонентов, ModelEditForm сокращен на 28%, ModelUploadForm на 40%)
- [x] API клиент ✅ (завершено - создан единый API клиент на основе fetch, все компоненты рефакторены)

**Средний приоритет:** 2/3 (67%)
- [x] Валидация через схемы ✅ (созданы схемы для всех сущностей: models, projects, employees, spheres)
- [x] react-hook-form ✅ (все формы рефакторены: ProjectForm, EmployeeForm, ModelUploadForm, ModelEditForm)
  - Текстовые поля полностью интегрированы с react-hook-form и Zod
  - Файлы валидируются вручную перед отправкой (для форм с загрузкой файлов)
- [ ] Централизованная обработка ошибок

---

## Примечания

- Задачи можно выполнять параллельно, но некоторые имеют зависимости
- Рекомендуемый порядок выполнения:
  1. API клиент (#3) - основа для остальных улучшений
  2. Кастомные хуки (#1) - упростит рефакторинг компонентов
  3. Валидация (#4) + react-hook-form (#5) - можно делать вместе
  4. Разбиение компонентов (#2) - после хуков и форм
  5. Обработка ошибок (#6) - можно делать параллельно с остальным

- После завершения каждой задачи необходимо:
  - Протестировать функциональность
  - Проверить отсутствие регрессий
  - Обновить документацию (если требуется)
  - Обновить этот файл (изменить статус)

